<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Calendrier de production - Brates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }
    .app {
      width: 100%;
      max-width: 1200px;
      background: #020617;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      border: 1px solid rgba(148,163,184,0.3);
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    header h1 { font-size: 1.5rem; font-weight: 700; }
    .subtitle { font-size: 0.9rem; color: #9ca3af; }

    /* NEW: Select Filter */
    #user-filter {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
      padding: 6px 12px;
      border-radius: 8px;
      margin-left: 12px;
      cursor: pointer;
    }

    .layout {
      display: grid;
      grid-template-columns: 1.1fr 1.6fr;
      gap: 20px;
      margin-top: 16px;
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }

    .calendar {
      background: #020617;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.3);
      padding: 16px;
    }
    .cal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .month-label { font-weight: 600; }
    .cal-nav button {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #1f2937;
      padding: 4px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .cal-nav button:hover { background: #1f2937; }

    .weekday-row, .day-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .weekday {
      text-align: center;
      font-size: 0.75rem;
      color: #9ca3af;
      padding: 4px 0;
    }
    .day-cell {
      position: relative;
      min-height: 60px;
      padding: 4px;
      border-radius: 10px;
      text-align: right;
      font-size: 0.8rem;
      cursor: pointer;
      border: 1px solid transparent;
    }
    .day-cell.other-month { opacity: 0.25; }
    .day-cell:hover {
      border-color: #1d4ed8;
      background: #020617;
    }
    .day-cell.selected {
      border-color: #3b82f6;
      background: radial-gradient(circle at top left, rgba(59,130,246,0.55), #020617);
    }
    .day-number { font-weight: 600; }

    /* Dots multi-crew */
    .event-dots {
      position: absolute;
      left: 6px;
      bottom: 6px;
      display: flex;
      gap: 4px;
    }
    .event-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }
    .event-dot.tc { background: #3b82f6; }
    .event-dot.dg { background: #ef4444; }
    .event-dot.jb { background: #ec4899; }
    .event-dot.generic { background: #22c55e; }

    .event-count {
      position: absolute;
      left: 6px;
      bottom: 20px;
      font-size: 0.7rem;
      color: #9ca3af;
      font-weight: 400;
    }

    .events-panel {
      background: #020617;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.3);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .no-events { font-size: 0.85rem; margin-top: 12px; color: #9ca3af; }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div style="display:flex; align-items:center; gap:10px;">
        <h1>Calendrier de production â€“ Brates</h1>

        <!-- NEW: USER SELECTION INPUT -->
        <select id="user-filter">
          <option value="all">Tous</option>
          <option value="TC">Tino</option>
          <option value="DG">Dominique</option>
          <option value="JB">Juliane</option>
        </select>
      </div>

      <div class="badge" id="last-refresh">DerniÃ¨re maj: â€“</div>
    </header>


    <!-- UI unchanged below -->
    <div class="layout">
      <section class="calendar">
        <div class="cal-header">
          <div class="month-label" id="month-label"></div>
          <div class="cal-nav">
            <button id="prev-month">&lt; Mois prÃ©c.</button>
            <button id="today-btn">Aujourdâ€™hui</button>
            <button id="next-month">Mois suiv. &gt;</button>
          </div>
        </div>
        <div class="weekday-row">
          <div class="weekday">Lun</div>
          <div class="weekday">Mar</div>
          <div class="weekday">Mer</div>
          <div class="weekday">Jeu</div>
          <div class="weekday">Ven</div>
          <div class="weekday">Sam</div>
          <div class="weekday">Dim</div>
        </div>
        <div class="day-grid" id="day-grid"></div>
      </section>

      <section class="events-panel">
        <h2 id="events-title">Prods du jour</h2>
        <small id="events-date-label"></small>
        <div id="events-list"></div>
      </section>
    </div>
  </div>

<script>
const SHEET_CSV_URLS = [
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG8oBk4Y39HEq7xq_DDg1WVCjN4TEf3opAJsEZi_yNEDEhg4TRcQ0bQabzQ3MgLwcREI075wRBVOUh/pub?gid=921922711&single=true&output=csv", 
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG8oBk4Y39HEq7xq_DDg1WVCjN4TEf3opAJsEZi_yNEDEhg4TRcQ0bQabzQ3MgLwcREI075wRBVOUh/pub?gid=583322571&single=true&output=csv",
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG8oBk4Y39HEq7xq_DDg1WVCjN4TEf3opAJsEZi_yNEDEhg4TRcQ0bQabzQ3MgLwcREI075wRBVOUh/pub?gid=1439501887&single=true&output=csv",
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG8oBk4Y39HEq7xq_DDg1WVCjN4TEf3opAJsEZi_yNEDEhg4TRcQ0bQabzQ3MgLwcREI075wRBVOUh/pub?gid=1883694412&single=true&output=csv"
];

let ALL_EVENTS = [];
let CURRENT_DATE = new Date();
let SELECTED_DATE = new Date();
let SEARCH_TERM = "";
let ACTIVE_USER = "all"; // NEW FILTER VARIABLE

document.getElementById("user-filter").addEventListener("change", e => {
  ACTIVE_USER = e.target.value;
  renderCalendar();
  renderEventsPanel();
});

function formatDateKey(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

function parseCSV(text){
  const lines=text.split(/\r?\n/).filter(l=>l.trim().length>0);
  const headers=lines[0].split(",").map(h=>h.trim());
  return lines.slice(1).map(l=>{
    const cols=l.split(",");
    const obj={}; 
    headers.forEach((h,i)=>obj[h]=cols[i]?cols[i].trim():"");
    return obj;
  });
}

async function loadSheetData(){
  const texts = await Promise.all(SHEET_CSV_URLS.map(url=>fetch(url).then(r=>r.text())));
  const rows = texts.flatMap(parseCSV);

  ALL_EVENTS = rows.map(r=>{
    if(!r.Date || !r.Event) return null;
    const d=new Date(r.Date);
    if(isNaN(d)) return null;

    return{
      date:d,
      dateKey:formatDateKey(d),
      prodName:r.Event,
      location:r.Location,
      client:r.Client,
      time:r.Time,
      crewTC:r.TC?.toLowerCase()=="x",
      crewDG:r.DG?.toLowerCase()=="x",
      crewJB:r.JB?.toLowerCase()=="x"
    };
  }).filter(Boolean);

  renderCalendar();
  renderEventsPanel();
}

function getFilteredEvents(){
  if(ACTIVE_USER==="all") return ALL_EVENTS;
  return ALL_EVENTS.filter(e=>
    (ACTIVE_USER==="TC" && e.crewTC) ||
    (ACTIVE_USER==="DG" && e.crewDG) ||
    (ACTIVE_USER==="JB" && e.crewJB)
  );
}

function renderCalendar(){
  const grid=document.getElementById("day-grid");
  grid.innerHTML="";

  const filtered=getFilteredEvents();
  const map=new Map();
  filtered.forEach(e=>{
    if(!map.has(e.dateKey)) map.set(e.dateKey,[]);
    map.get(e.dateKey).push(e);
  });

  const d=new Date(CURRENT_DATE.getFullYear(),CURRENT_DATE.getMonth(),1);
  const start=(d.getDay()+6)%7;
  const days=new Date(CURRENT_DATE.getFullYear(),CURRENT_DATE.getMonth()+1,0).getDate();

  for(let i=0;i<42;i++){
    const cell=document.createElement("div");
    cell.className="day-cell";

    const date=new Date(CURRENT_DATE.getFullYear(),CURRENT_DATE.getMonth(),i-start+1);
    const key=formatDateKey(date);
    if(date.getMonth()!=CURRENT_DATE.getMonth()) cell.classList.add("other-month");

    cell.innerHTML=`<div class="day-number">${date.getDate()}</div>`;

    if(map.has(key)){
      cell.innerHTML+=`<div style="color:#22c55e;font-size:12px;position:absolute;bottom:6px;left:6px">${map.get(key).length} prods</div>`;
    }

    cell.onclick=()=>{SELECTED_DATE=date;renderEventsPanel();renderCalendar();}
    if(key===formatDateKey(SELECTED_DATE)) cell.classList.add("selected");
    grid.appendChild(cell);
  }
}

function renderEventsPanel(){
  const box=document.getElementById("events-list");
  box.innerHTML="";
  const key=formatDateKey(SELECTED_DATE);

  const events=getFilteredEvents().filter(e=>e.dateKey===key);

  if(events.length===0){
    box.innerHTML=`<div class="no-events">Aucune production ce jour.</div>`;
    return;
  }

  events.forEach(e=>{
    box.innerHTML+=`
      <div class="event-card">
        <div class="event-title">${e.prodName}</div>
        <div class="event-time">Heure: ${e.time||"-"}</div>
        <div class="event-crew">Crew:
          ${e.crewTC?"ðŸŸ¦ Tino ":""}
          ${e.crewDG?"ðŸŸ¥ Dominique ":""}
          ${e.crewJB?"ðŸŒ¸ Juliane ":""}
        </div>
      </div>`;
  });
}

document.getElementById("prev-month").onclick=()=>{
  CURRENT_DATE=new Date(CURRENT_DATE.getFullYear(),CURRENT_DATE.getMonth()-1,1);
  renderCalendar();
};

document.getElementById("next-month").onclick=()=>{
  CURRENT_DATE=new Date(CURRENT_DATE.getFullYear(),CURRENT_DATE.getMonth()+1,1);
  renderCalendar();
};

document.getElementById("today-btn").onclick=()=>{
  SELECTED_DATE=new Date();
  CURRENT_DATE=new Date();
  renderCalendar();
  renderEventsPanel();
};

loadSheetData();
</script>

</body>
</html>
