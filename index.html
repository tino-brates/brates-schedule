<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Calendrier de production - Brates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }
    .app {
      width: 100%;
      max-width: 1200px;
      background: #020617;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      border: 1px solid rgba(148,163,184,0.3);
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    header h1 { font-size: 1.5rem; font-weight: 700; }
    .subtitle { font-size: 0.9rem; color: #9ca3af; }

    /* ---- CREW FILTER UI ---- */
    .filter-row {
      margin-bottom: 12px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    select {
      padding:6px 10px;
      background:#111827;
      border:1px solid #1f2937;
      border-radius:8px;
      color:#e5e7eb;
      cursor:pointer;
    }

    .layout {
      display: grid;
      grid-template-columns: 1.1fr 1.6fr;
      gap: 20px;
      margin-top: 10px;
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }

    .calendar {
      background: #020617;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.3);
      padding: 16px;
    }
    .cal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .month-label { font-weight: 600; }
    .cal-nav button {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #1f2937;
      padding: 4px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .cal-nav button:hover { background: #1f2937; }

    .weekday-row, .day-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .weekday {
      text-align: center;
      font-size: 0.75rem;
      color: #9ca3af;
      padding: 4px 0;
    }

    .day-cell {
      position: relative;
      min-height: 60px;
      padding: 4px;
      border-radius: 10px;
      text-align: right;
      font-size: 0.8rem;
      cursor: pointer;
      border: 1px solid transparent;
    }
    .day-cell.other-month { opacity: 0.25; }
    .day-cell:hover {
      border-color: #1d4ed8;
      background: #020617;
    }
    .day-cell.selected {
      border-color: #3b82f6;
      background: radial-gradient(circle at top left, rgba(59,130,246,0.55), #020617);
    }
    .day-number { font-weight: 600; }

    /* DOT STYLE */
    .event-dots {
      position: absolute;
      left: 6px;
      bottom: 6px;
      display: flex;
      gap: 4px;
    }
    .event-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }
    .event-dot.tc { background: #3b82f6; }
    .event-dot.dg { background: #ef4444; }
    .event-dot.jb { background: #ec4899; }
    .event-dot.generic { background: #22c55e; }

    .event-count {
      position: absolute;
      left: 6px;
      bottom: 20px;
      font-size: 0.7rem;
      color: #9ca3af;
      font-weight: 400;
    }

    .events-panel {
      background: #020617;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.3);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .event-card {
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 10px;
      margin-bottom: 8px;
      background: radial-gradient(circle at top left, rgba(59,130,246,0.12), #020617);
    }
  </style>
</head>

<body>
<div class="app">

  <header>
    <div>
      <h1>Calendrier de production â€“ Brates</h1>
      <div class="subtitle">DonnÃ©es Google Sheets Â· Prods, cars rÃ©gie & Ã©quipe</div>
    </div>
    <div class="badge" id="last-refresh">â€“</div>
  </header>

  <!-- ðŸ”¥ CREW FILTER -->
  <div class="filter-row">
    <label>Afficher :</label>
    <select id="crew-filter">
      <option value="all">Tous</option>
      <option value="TC">Tino</option>
      <option value="DG">Dominique</option>
      <option value="JB">Juliane</option>
    </select>
  </div>

  <div class="layout">

    <section class="calendar">
      <div class="cal-header">
        <div id="month-label" class="month-label"></div>
        <div class="cal-nav">
          <button id="prev-month">&lt;</button>
          <button id="today-btn">Aujourdâ€™hui</button>
          <button id="next-month">&gt;</button>
        </div>
      </div>

      <div class="weekday-row">
        <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div>
        <div>Ven</div><div>Sam</div><div>Dim</div>
      </div>
      <div id="day-grid" class="day-grid"></div>
    </section>

    <section class="events-panel">
      <h2 id="events-title">Prods du jour</h2>
      <small id="events-date-label"></small>
      <div id="events-list"></div>
    </section>

  </div>
</div>

<script>
let FILTER_CREW="all";
let ALL_EVENTS=[];
let CURRENT_DATE=new Date();
let SELECTED_DATE=new Date();

const URLS=[
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG8oBk4Y39HEq7xq_DDg1WVCjN4TEf3opAJsEZi_yNEDEhg4TRcQ0bQabzQ3MgLwcREI075wRBVOUh/pub?gid=921922711&single=true&output=csv",
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG8oBk4Y39HEq7xq_DDg1WVCjN4TEf3opAJsEZi_yNEDEhg4TRcQ0bQabzQ3MgLwcREI075wRBVOUh/pub?gid=583322571&single=true&output=csv",
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG8oBk4Y39HEq7xq_DDg1WVCjN4TEf3opAJsEZi_yNEDEhg4TRcQ0bQabzQ3MgLwcREI075wRBVOUh/pub?gid=1439501887&single=true&output=csv",
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG8oBk4Y39HEq7xq_DDg1WVCjN4TEf3opAJsEZi_yNEDEhg4TRcQ0bQabzQ3MgLwcREI075wRBVOUh/pub?gid=1883694412&single=true&output=csv",
];

function formatDateKey(d){return d.toISOString().split("T")[0];}

function getEventsByDate(d){
  return ALL_EVENTS.filter(e=>{
    if(e.dateKey!==d) return false;
    if(FILTER_CREW==="TC"&& !e.TC) return false;
    if(FILTER_CREW==="DG"&& !e.DG) return false;
    if(FILTER_CREW==="JB"&& !e.JB) return false;
    return true;
  });
}

async function load(){
  const texts=await Promise.all(URLS.map(u=>fetch(u).then(r=>r.text())));
  const rows=texts.flatMap(t=>t.split(/\r?\n/)).filter(l=>l.includes(","));

  ALL_EVENTS=rows.slice(1).map(line=>{
    const c=line.split(",");
    let crewList=[];
    let flags={TC:false,DG:false,JB:false};

    ["TC","DG","JB"].forEach((k,i)=>{
      if(["x","1","oui","yes"].includes(c[7+i]?.toLowerCase?.())){flags[k]=true;crewList.push(k);}
    });

    return{
      date:new Date(c[0]),
      dateKey:c[0],
      name:c[1],
      location:c[2],
      crewList:crewList.join(", "),
      ...flags
    };
  });

  document.getElementById("last-refresh").textContent="Maj: "+new Date().toLocaleString("fr-CH");
  render();
}

function render(){
  renderCalendar();
  renderEvents();
}

function renderCalendar(){
  const grid=document.getElementById("day-grid");
  grid.innerHTML="";
  
  for(let i=1;i<=31;i++){
    let d=new Date(CURRENT_DATE.getFullYear(),CURRENT_DATE.getMonth(),i);
    if(isNaN(d)) continue;

    let key=formatDateKey(d);
    const events=getEventsByDate(key);
    const cell=document.createElement("div");
    cell.className="day-cell";

    cell.innerHTML=`<div class="day-number">${i}</div>`;

    if(events.length){
      const dot=document.createElement("div");
      dot.className="event-dots";
      if(events.some(e=>e.TC)) dot.innerHTML+=`<div class="event-dot tc"></div>`;
      if(events.some(e=>e.DG)) dot.innerHTML+=`<div class="event-dot dg"></div>`;
      if(events.some(e=>e.JB)) dot.innerHTML+=`<div class="event-dot jb"></div>`;
      if(!events.some(e=>e.TC||e.DG||e.JB)) dot.innerHTML+=`<div class="event-dot generic"></div>`;
      cell.appendChild(dot);
    }

    cell.onclick=()=>{SELECTED_DATE=d;render();}
    grid.appendChild(cell);
  }
}

function renderEvents(){
  const list=document.getElementById("events-list");
  const key=formatDateKey(SELECTED_DATE);
  const ev=getEventsByDate(key);

  document.getElementById("events-date-label").innerText=
    SELECTED_DATE.toLocaleDateString("fr-CH",{weekday:"long",day:"numeric",month:"long"});

  list.innerHTML=ev.length?ev.map(e=>`
    <div class="event-card">
      <div><strong>Prod:</strong> ${e.name}</div>
      <div><strong>Lieu:</strong> ${e.location}</div>
      <div><strong>Crew:</strong> ${e.crewList||"â€“"}</div>
    </div>
  `).join(""):"<div>Aucune prod.</div>";
}

document.getElementById("crew-filter").onchange=e=>{
  FILTER_CREW=e.target.value;
  render();
};

load();
</script>
</body>
</html>
