<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Calendrier de production - Brates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }
    .app {
      width: 100%;
      max-width: 1200px;
      background: #020617;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      border: 1px solid rgba(148,163,184,0.3);
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px; /* reduced spacing to fit filter */
    }
    header h1 { font-size: 1.5rem; font-weight: 700; }
    .subtitle { font-size: 0.9rem; color: #9ca3af; }

    /* ðŸ”¥ STYLE DU SELECTEUR CREW */
    #crewFilter {
      padding:6px 10px;
      border-radius:8px;
      background:#111827;
      border:1px solid #1f2937;
      color:white;
      cursor:pointer;
      margin-bottom:12px;
    }

    /* --- RESTE DE TON CSS IDENTIQUE --- */
    .layout {
      display: grid;
      grid-template-columns: 1.1fr 1.6fr;
      gap: 20px;
      margin-top: 16px;
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }

    .calendar {
      background: #020617;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.3);
      padding: 16px;
    }
    .cal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .month-label { font-weight: 600; }
    .cal-nav button {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #1f2937;
      padding: 4px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .cal-nav button:hover { background: #1f2937; }

    .weekday-row, .day-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .weekday {
      text-align: center;
      font-size: 0.75rem;
      color: #9ca3af;
      padding: 4px 0;
    }
    .day-cell {
      position: relative;
      min-height: 60px;
      padding: 4px;
      border-radius: 10px;
      text-align: right;
      font-size: 0.8rem;
      cursor: pointer;
      border: 1px solid transparent;
    }
    .day-cell.other-month { opacity: 0.25; }
    .day-cell:hover {
      border-color: #1d4ed8;
      background: #020617;
    }
    .day-cell.selected {
      border-color: #3b82f6;
      background: radial-gradient(circle at top left, rgba(59,130,246,0.55), #020617);
    }
    .day-number { font-weight: 600; }

    .event-dots {
      position: absolute;
      left: 6px;
      bottom: 6px;
      display: flex;
      gap: 4px;
    }
    .event-dot { width: 8px; height: 8px; border-radius: 999px; }

    .event-dot.tc { background: #3b82f6; } /* bleu */
    .event-dot.dg { background: #ef4444; } /* rouge */
    .event-dot.jb { background: #ec4899; } /* rose */
    .event-dot.generic { background: #22c55e; }

    .event-count {
      position: absolute;
      left: 6px;
      bottom: 20px;
      font-size: 0.7rem;
      color: #9ca3af;
      font-weight: 400;
    }

    .events-panel {
      background: #020617;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.3);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .events-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }
    .events-header h2 { font-size: 1.1rem; font-weight: 600; }

    .search-bar input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      background:#020617;
      border:1px solid #1f2937;
      color:white;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Calendrier de production â€“ Brates</h1>
        <div class="subtitle">DonnÃ©es depuis Google Sheets Â· Prods, cars rÃ©gie & Ã©quipes</div>
      </div>
      <div class="badge" id="last-refresh">DerniÃ¨re maj: â€“</div>
    </header>

    <!-- ðŸ”¥ AJOUT FILTRE CREW -->
    <select id="crewFilter">
      <option value="all">Toutes les productions</option>
      <option value="TC">Tino</option>
      <option value="DG">Dominique</option>
      <option value="JB">Juliane</option>
    </select>

    <div class="layout">
      <section class="calendar">
        <div class="cal-header">
          <div class="month-label" id="month-label"></div>
          <div class="cal-nav">
            <button id="prev-month">&lt; Mois prÃ©c.</button>
            <button id="today-btn">Aujourdâ€™hui</button>
            <button id="next-month">Mois suiv. &gt;</button>
          </div>
        </div>

        <div class="weekday-row">
          <div class="weekday">Lun</div><div class="weekday">Mar</div><div class="weekday">Mer</div>
          <div class="weekday">Jeu</div><div class="weekday">Ven</div><div class="weekday">Sam</div><div class="weekday">Dim</div>
        </div>
        <div id="day-grid" class="day-grid"></div>
      </section>

      <section class="events-panel">
        <div class="events-header">
          <div>
            <h2 id="events-title">Prods du jour</h2>
            <small id="events-date-label"></small>
          </div>
          <div class="badge" id="events-count-badge">0 prods</div>
        </div>

        <div class="search-bar">
          <input id="search-input" type="text" placeholder="Rechercher (prod, lieu, car rÃ©gie, crew, client)..." />
        </div>

        <div id="events-list" class="events-list"></div>
      </section>
    </div>
  </div>

<script>
const SHEET_CSV_URLS = [
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG8oBk4Y39HEq7xq_DDg1WVCjN4TEf3opAJsEZi_yNEDEhg4TRcQ0bQabzQ3MgLwcREI075wRBVOUh/pub?gid=921922711&single=true&output=csv",
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG8oBk4Y39HEq7xq_DDg1WVCjN4TEf3opAJsEZi_yNEDEhg4TRcQ0bQabzQ3MgLwcREI075wRBVOUh/pub?gid=583322571&single=true&output=csv",
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG8oBk4Y39HEq7xq_DDg1WVCjN4TEf3opAJsEZi_yNEDEhg4TRcQ0bQabzQ3MgLwcREI075wRBVOUh/pub?gid=1439501887&single=true&output=csv",
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG8oBk4Y39HEq7xq_DDg1WVCjN4TEf3opAJsEZi_yNEDEhg4TRcQ0bQabzQ3MgLwcREI075wRBVOUh/pub?gid=1883694412&single=true&output=csv"
];

let ACTIVE_CREW_FILTER = "all"; // ðŸ”¥

let ALL_EVENTS = [];
let CURRENT_DATE = new Date();
let SELECTED_DATE = new Date();
let SEARCH_TERM = "";

function formatDateKey(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

async function loadSheetData(){
  const texts = await Promise.all(SHEET_CSV_URLS.map(url => fetch(url).then(r=>r.text())));
  const rows = texts.flatMap(t=>t.split("\n").slice(1).map(l=>l.split(",")));
  
  ALL_EVENTS = rows.map(cols=>{
    if(!cols[0]) return null;
    
    const date = new Date(cols[0]);
    return {
      date,
      dateKey:cols[0],
      time:cols[1],
      prodName:cols[2],
      location:cols[3],
      carRegie:cols[4],
      camera:cols[5],
      delivery:cols[6],
      internet:cols[7],
      client:cols[8],
      crewTC:cols[9]?.trim().toLowerCase()==="x",
      crewDG:cols[10]?.trim().toLowerCase()==="x",
      crewJB:cols[11]?.trim().toLowerCase()==="x",
      crew:[
        cols[9]?.trim().toLowerCase()==="x" ? "Tino" : null,
        cols[10]?.trim().toLowerCase()==="x" ? "Dominique" : null,
        cols[11]?.trim().toLowerCase()==="x" ? "Juliane" : null
      ].filter(Boolean).join(" / ")
    };
  }).filter(Boolean);

  renderCalendar();
  renderEventsPanel();
}

function getEventsByDateKey(dateKey){
  return ALL_EVENTS.filter(e=>{
    if(e.dateKey !== dateKey) return false;

    if(ACTIVE_CREW_FILTER==="TC" && !e.crewTC) return false;
    if(ACTIVE_CREW_FILTER==="DG" && !e.crewDG) return false;
    if(ACTIVE_CREW_FILTER==="JB" && !e.crewJB) return false;

    return true;
  });
}

document.getElementById("crewFilter").addEventListener("change", e=>{
  ACTIVE_CREW_FILTER = e.target.value;
  renderCalendar();
  renderEventsPanel();
});

function renderCalendar(){
  const year=CURRENT_DATE.getFullYear();
  const month=CURRENT_DATE.getMonth();

  document.getElementById("month-label").textContent=
    new Intl.DateTimeFormat("fr-CH",{month:"long",year:"numeric"}).format(new Date(year,month,1));

  const start=new Date(year,month,1).getDay() || 7;
  const days=new Date(year,month+1,0).getDate();
  
  const grid=document.getElementById("day-grid");
  grid.innerHTML="";

  let offset=start-1;
  
  for(let i=1;i<=42;i++){
    const div=document.createElement("div");
    div.className="day-cell";

    let num=i-offset;
    let d=new Date(year,month,num);

    if(num<=0){
      num=new Date(year,month,0).getDate()+num;
      d=new Date(year,month-1,num);
      div.classList.add("other-month");
    }else if(num>days){
      num=num-days;
      d=new Date(year,month+1,num);
      div.classList.add("other-month");
    }

    div.innerHTML=`<div class='day-number'>${num}</div>`;

    const key=formatDateKey(d);
    const events=getEventsByDateKey(key);

    if(events.length){
      const dots=`${
        events.some(e=>e.crewTC)?"<div class='event-dot tc'></div>":""
      }${events.some(e=>e.crewDG)?"<div class='event-dot dg'></div>":""}${
        events.some(e=>e.crewJB)?"<div class='event-dot jb'></div>":""
      }${events.every(e=>!e.crewTC&&!e.crewDG&&!e.crewJB)?"<div class='event-dot generic'></div>":""}`;

      div.innerHTML+=`<div class="event-dots">${dots}</div>
                      <div class="event-count">${events.length} prod${events.length>1?"s":""}</div>`;
    }

    if(key===formatDateKey(SELECTED_DATE)) div.classList.add("selected");

    div.onclick=()=>{
      SELECTED_DATE=d;
      renderCalendar();
      renderEventsPanel();
    };

    grid.appendChild(div);
  }
}

function renderEventsPanel(){
  const events=getEventsByDateKey(formatDateKey(SELECTED_DATE));
  const list=document.getElementById("events-list");
  list.innerHTML="";

  document.getElementById("events-count-badge").textContent=
    events.length+" production"+(events.length>1?"s":"");

  events.forEach(e=>{
    list.innerHTML+=`
      <div class="event-card">
        <div class="event-title">${e.prodName}</div>
        <div class="event-time">${e.time||""}</div>
        <div class="event-meta">
          <span><b>Lieu:</b> ${e.location}</span>
          <span><b>Client:</b> ${e.client}</span>
          <span><b>CamÃ©ras:</b> ${e.camera}</span>
          <span><b>Car rÃ©gie:</b> ${e.carRegie}</span>
          <span><b>Delivery:</b> ${e.delivery}</span>
        </div>
        <div class="event-crew"><b>Ã‰quipe:</b> ${e.crew||"-"}</div>
      </div>
    `;
  });
}

document.getElementById("today-btn").onclick=()=>{
  CURRENT_DATE=new Date();
  SELECTED_DATE=new Date();
  renderCalendar();
  renderEventsPanel();
};

document.getElementById("prev-month").onclick=()=>{
  CURRENT_DATE=new Date(CURRENT_DATE.getFullYear(),CURRENT_DATE.getMonth()-1);
  renderCalendar();
};

document.getElementById("next-month").onclick=()=>{
  CURRENT_DATE=new Date(CURRENT_DATE.getFullYear(),CURRENT_DATE.getMonth()+1);
  renderCalendar();
};

loadSheetData();
</script>
</body>
</html>
