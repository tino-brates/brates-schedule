<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Brates ‚Äî Production Scheduler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      background:#0f172a;
      color:white;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      display:flex;justify-content:center;
      padding:20px;
    }

    .app{
      width:100%;max-width:1200px;
      padding:20px;border-radius:16px;
      background:#020617;border:1px solid #1e293b;
      box-shadow:0 20px 40px rgba(0,0,0,.5);
    }

    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    .subtitle{color:#94a3b8;font-size:.9rem;}

    select{
      padding:6px 12px;border-radius:8px;border:1px solid #1e293b;
      background:#111827;color:white;cursor:pointer;
    }

    .filter-row{
      margin-top:10px;margin-bottom:20px;
      display:flex;align-items:center;gap:10px;
    }

    .layout{
      display:grid;grid-template-columns:1.1fr 1.6fr;gap:20px;
    }

    @media(max-width:900px){
      .layout{grid-template-columns:1fr;}
    }

    .calendar, .events-panel{
      border:1px solid #1e293b;
      border-radius:12px;padding:16px;
      background:#0b1221;
    }

    .month-label{font-weight:700;font-size:1.2rem;margin-bottom:10px;}

    .weekday-row,.day-grid{
      display:grid;grid-template-columns:repeat(7,1fr);gap:4px;
    }

    .weekday{font-size:.75rem;color:#94a3b8;text-align:center;padding:4px;}

    .day-cell{
      min-height:60px;border-radius:10px;padding:6px;
      cursor:pointer;position:relative;font-size:.8rem;text-align:right;
      border:1px solid transparent;
    }

    .day-cell:hover{border-color:#1d4ed8;}

    .day-cell.selected{
      border-color:#3b82f6;
      background:radial-gradient(circle at top left,rgba(59,130,246,.4),#0b1221);
    }

    .day-number{font-weight:600;}

    .event-dots{position:absolute;left:6px;bottom:6px;display:flex;gap:4px;}
    .event-dot{width:8px;height:8px;border-radius:100%;}
    .tc{background:#3b82f6;}
    .dg{background:#ef4444;}
    .jb{background:#ec4899;}
    .generic{background:#22c55e;}

    .event-count{
      position:absolute;left:6px;bottom:20px;font-size:.7rem;color:#94a3b8;
    }

    .event-card{
      background:#102038;padding:10px;border-radius:8px;border:1px solid #1e293b;margin-bottom:8px;
    }
    .event-card strong{color:#38bdf8;}
  </style>
</head>

<body>
<div class="app">

<header>
  <div>
    <h1>Calendrier Prod ‚Äî Brates</h1>
    <div class="subtitle">Sync Google Sheets ¬∑ Car r√©gie ¬∑ Crew assign√©</div>
  </div>
  <div id="last-refresh" style="font-size:.8rem;color:#94a3b8;">‚Äì</div>
</header>

<div class="filter-row">
  <label>Afficher pour :</label>
  <select id="crew-filter">
    <option value="all">Tous</option>
    <option value="TC">Tino</option>
    <option value="DG">Dominique</option>
    <option value="JB">Juliane</option>
  </select>
</div>

<div class="layout">
  <section class="calendar">
    <div class="month-label" id="month-label"></div>
    <div class="weekday-row">
      <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
    </div>
    <div id="day-grid" class="day-grid"></div>
  </section>

  <section class="events-panel">
    <h2 id="events-title">Prods du jour</h2>
    <small id="events-date-label"></small>
    <div id="events-list" style="margin-top:10px;"></div>
  </section>
</div>

</div>

<script>
let FILTER="all";
let ALL_EVENTS=[];
let CURRENT=new Date();
let SELECTED=new Date();

const URLS=[
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG8oBk4Y39HEq7xq_DDg1WVCjN4TEf3opAJsEZi_yNEDEhg4TRcQ0bQabzQ3MgLwcREI075wRBVOUh/pub?gid=921922711&single=true&output=csv",
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG8oBk4Y39HEq7xq_DDg1WVCjN4TEf3opAJsEZi_yNEDEhg4TRcQ0bQabzQ3MgLwcREI075wRBVOUh/pub?gid=583322571&single=true&output=csv",
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG8oBk4Y39HEq7xq_DDg1WVCjN4TEf3opAJsEZi_yNEDEhg4TRcQ0bQabzQ3MgLwcREI075wRBVOUh/pub?gid=1439501887&single=true&output=csv",
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG8oBk4Y39HEq7xq_DDg1WVCjN4TEf3opAJsEZi_yNEDEhg4TRcQ0bQabzQ3MgLwcREI075wRBVOUh/pub?gid=1883694412&single=true&output=csv"
];

function key(d){
  return d.toISOString().split("T")[0];
}

async function load(){
  ALL_EVENTS=[];

  const csvArr=await Promise.all(URLS.map(u=>fetch(u).then(r=>r.text())));

  csvArr.forEach(text=>{
    const lines=text.split(/\r?\n/).map(l=>l.split(","));
    lines.slice(1).forEach(cols=>{
      if(!cols[0] || !cols[2]) return;

      const date=new Date(cols[0]);
      const flags={
        TC:["x","1","oui","yes"].includes((cols[9]||"").toLowerCase()),
        DG:["x","1","oui","yes"].includes((cols[10]||"").toLowerCase()),
        JB:["x","1","oui","yes"].includes((cols[11]||"").toLowerCase()),
      };

      ALL_EVENTS.push({
        dateKey:cols[0],
        date,
        name:cols[2],
        location:cols[3],
        client:cols[8],
        ...flags,
        crew:[
          flags.TC?"Tino":null,
          flags.DG?"Dominique":null,
          flags.JB?"Juliane":null
        ].filter(Boolean).join(" / ")
      });
    });
  });

  document.getElementById("last-refresh").innerText="Maj : "+new Date().toLocaleString("fr-CH");

  render();
}

function render(){
  renderCalendar();
  renderEvents();
}

function filteredEventsByDate(dateKey){
  return ALL_EVENTS.filter(e=>{
    if(e.dateKey!==dateKey) return false;
    if(FILTER==="TC"&&!e.TC) return false;
    if(FILTER==="DG"&&!e.DG) return false;
    if(FILTER==="JB"&&!e.JB) return false;
    return true;
  });
}

function renderCalendar(){
  const grid=document.getElementById("day-grid");
  grid.innerHTML="";

  document.getElementById("month-label").innerText =
    CURRENT.toLocaleDateString("fr-CH",{month:"long",year:"numeric"});

  for(let d=1;d<=31;d++){
    const date=new Date(CURRENT.getFullYear(),CURRENT.getMonth(),d);
    if(date.getMonth()!==CURRENT.getMonth()) continue;

    const cell=document.createElement("div");
    cell.className="day-cell";
    if(key(date)===key(SELECTED)) cell.classList.add("selected");

    const events=filteredEventsByDate(key(date));

    cell.innerHTML=`<div class='day-number'>${d}</div>`;

    if(events.length){
      const dots=document.createElement("div");
      dots.className="event-dots";

      if(events.some(e=>e.TC)) dots.innerHTML+=`<div class="event-dot tc"></div>`;
      if(events.some(e=>e.DG)) dots.innerHTML+=`<div class="event-dot dg"></div>`;
      if(events.some(e=>e.JB)) dots.innerHTML+=`<div class="event-dot jb"></div>`;
      if(!events.some(e=>e.TC||e.DG||e.JB)) dots.innerHTML+=`<div class="event-dot generic"></div>`;
      cell.appendChild(dots);

      cell.innerHTML+=`<div class='event-count'>${events.length}</div>`;
    }

    cell.onclick=()=>{SELECTED=date;render();};
    grid.appendChild(cell);
  }
}

function renderEvents(){
  const list=document.getElementById("events-list");
  const set=filteredEventsByDate(key(SELECTED));

  document.getElementById("events-date-label").innerText=
    SELECTED.toLocaleDateString("fr-CH",{weekday:"long",day:"numeric",month:"long"});

  if(!set.length){
    list.innerHTML="<div style='color:#94a3b8;'>Aucune production.</div>";
    return;
  }

  list.innerHTML=set.map(e=>`
    <div class="event-card">
      <strong>${e.name}</strong><br>
      üìç ${e.location || "-"}<br>
      üé• Crew : ${e.crew || "-"}<br>
      üßæ Client : ${e.client || "-"}
    </div>
  `).join("");
}

document.getElementById("crew-filter").onchange = e => {
  FILTER=e.target.value;
  render();
};

load();
</script>
</body>
</html>
